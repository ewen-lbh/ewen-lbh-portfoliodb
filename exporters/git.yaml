name: Git Uploader

description: Commit the database.json file to a Git repository and push.

requires:
    - git

data:
    # URL to the Git repository
    url:

    # Commit message used
    commit:

    # Where to copy the database.json file in the repository
    path: database.json

    # Additional flags to pass to git commit
    git_commit_flags: ""

    # Additional flags to pass to git push
    git_push_flags: ""

    # Additional flags to pass to git clone
    git_clone_flags: ""

    # Additional flags to pass to git add
    git_add_flags: ""

after:
    # - run: test ! -d .ortfodb-tmp || echo .ortfodb-tmp exists, please remove it >&2; exit 1
    - log: [Cloning, blue, 'repository {{ index .Data "url" }}']
    - run: git clone {{ index .Data "git_clone_flags" }} {{ index .Data "url" }} .ortfodb-tmp
    - log: [Comitting, blue, "{{ .Ctx.OutputDatabaseFile }} to the repository"]
    - run: cp {{ .Ctx.OutputDatabaseFile }} .ortfodb-tmp/{{ index .Data "path" }}
    - run: cd .ortfodb-tmp && git add {{ index .Data "git_add_flags" }} {{ index .Data "path" }} && git commit {{ index .Data "git_commit_flags" }} -m '{{ index .Data "commit" }}'
    - log: [Pushing, blue, "changes to the repository"]
    - run: cd .ortfodb-tmp && git push {{ index .Data "git_push_flags" }}
    - log: [Cleaning up, dim, ".ortfodb-tmp directory"]
    - run: rm -rf .ortfodb-tmp
